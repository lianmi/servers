<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="2290px" preserveAspectRatio="none" style="width:1535px;height:2290px;" version="1.1" viewBox="0 0 1535 2290" width="1535px" zoomAndPan="magnify"><defs><filter height="300%" id="f9hx7dtlzbg12" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="272" x2="272" y1="40.4883" y2="2247.3965"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="715" x2="715" y1="40.4883" y2="2247.3965"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1162" x2="1162" y1="40.4883" y2="2247.3965"/><rect fill="#FEFECE" filter="url(#f9hx7dtlzbg12)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="44" x="248" y="5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="30" x="255" y="25.5352">user</text><rect fill="#FEFECE" filter="url(#f9hx7dtlzbg12)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="44" x="248" y="2246.3965"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="30" x="255" y="2266.9316">user</text><rect fill="#FEFECE" filter="url(#f9hx7dtlzbg12)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="56" x="685" y="5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="42" x="692" y="25.5352">server</text><rect fill="#FEFECE" filter="url(#f9hx7dtlzbg12)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="56" x="685" y="2246.3965"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="42" x="692" y="2266.9316">server</text><rect fill="#FEFECE" filter="url(#f9hx7dtlzbg12)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="74" x="1123" y="5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="60" x="1130" y="25.5352">business</text><rect fill="#FEFECE" filter="url(#f9hx7dtlzbg12)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="74" x="1123" y="2246.3965"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="60" x="1130" y="2266.9316">business</text><rect fill="#EEEEEE" filter="url(#f9hx7dtlzbg12)" height="3" style="stroke: #EEEEEE; stroke-width: 1.0;" width="1528" x="0" y="71.1436"/><line style="stroke: #000000; stroke-width: 1.0;" x1="0" x2="1528" y1="71.1436" y2="71.1436"/><line style="stroke: #000000; stroke-width: 1.0;" x1="0" x2="1528" y1="74.1436" y2="74.1436"/><rect fill="#EEEEEE" filter="url(#f9hx7dtlzbg12)" height="23.3105" style="stroke: #000000; stroke-width: 2.0;" width="44" x="742" y="60.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="26" x="748" y="77.0566">下单</text><polygon fill="#A80036" points="703,111.1094,713,115.1094,703,119.1094,707,115.1094" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="272" x2="709" y1="115.1094" y2="115.1094"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="156" x="279" y="110.3672">发起下单 状态 OS_Prepare</text><polygon fill="#A80036" points="1150,140.4199,1160,144.4199,1150,148.4199,1154,144.4199" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="715" x2="1156" y1="144.4199" y2="144.4199"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="192" x="722" y="139.6777">修改 状态 为 OS_SendOK 给商户</text><polygon fill="#A80036" points="726,169.7305,716,173.7305,726,177.7305,722,173.7305" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="720" x2="1161" y1="173.7305" y2="173.7305"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="87" x="732" y="168.9883">接受订单的ack</text><polygon fill="#A80036" points="283,257.6279,273,261.6279,283,265.6279,279,261.6279" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="277" x2="714" y1="261.6279" y2="261.6279"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="312" x="289" y="256.8857">推送 订单接受成功 事件 修改状态 OS_RecvOK 给用户</text><path d="M95,186.7305 L95,318.7305 L263,318.7305 L263,196.7305 L253,186.7305 L95,186.7305 " fill="#FBFB77" filter="url(#f9hx7dtlzbg12)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M253,186.7305 L253,196.7305 L263,196.7305 L253,186.7305 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="91" x="101" y="204.2988">此时订单未支付</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="105" y="219.6094"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="91" x="101" y="234.9199">如果价格不满意</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="105" y="250.2305"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="104" x="101" y="265.541">可以进行普通聊天</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="105" y="280.8516"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="147" x="101" y="296.1621">和商家修改成 满意的价格</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="105" y="311.4727"/><rect fill="#EEEEEE" filter="url(#f9hx7dtlzbg12)" height="3" style="stroke: #EEEEEE; stroke-width: 1.0;" width="1528" x="0" y="351.2256"/><line style="stroke: #000000; stroke-width: 1.0;" x1="0" x2="1528" y1="351.2256" y2="351.2256"/><line style="stroke: #000000; stroke-width: 1.0;" x1="0" x2="1528" y1="354.2256" y2="354.2256"/><rect fill="#EEEEEE" filter="url(#f9hx7dtlzbg12)" height="28.0215" style="stroke: #000000; stroke-width: 2.0;" width="130" x="699" y="338.2148"/><text fill="#000000" font-family="sans-serif" font-size="17" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="116" x="705" y="358.6504">商量价格开始=</text><polygon fill="#A80036" points="703,421.5127,713,425.5127,703,429.5127,707,425.5127" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="272" x2="709" y1="425.5127" y2="425.5127"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="173" x="279" y="420.7705">发送普通消息 进行和商户沟通</text><path d="M86,381.2363 L86,452.2363 L263,452.2363 L263,391.2363 L253,381.2363 L86,381.2363 " fill="#FBFB77" filter="url(#f9hx7dtlzbg12)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M253,381.2363 L253,391.2363 L263,391.2363 L253,381.2363 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="156" x="92" y="398.8047">如果商品价格是不可修改的</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="96" y="414.1152"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="91" x="92" y="429.4258">可以跳过这一步</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="96" y="444.7363"/><polygon fill="#A80036" points="1150,478.7891,1160,482.7891,1150,486.7891,1154,482.7891" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="715" x2="1156" y1="482.7891" y2="482.7891"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="722" y="478.0469">普通聊天 进行 和商户沟通 价格</text><polygon fill="#A80036" points="726,508.0996,716,512.0996,726,516.0996,722,512.0996" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="720" x2="1161" y1="512.0996" y2="512.0996"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="423" x="732" y="507.3574">价格商定差不多了 ， 商户发起 订单修改接口 将订单的金额 进行修改修改</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1162" x2="1204" y1="541.4102" y2="541.4102"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1204" x2="1204" y1="541.4102" y2="554.4102"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1163" x2="1204" y1="554.4102" y2="554.4102"/><polygon fill="#A80036" points="1173,550.4102,1163,554.4102,1173,558.4102,1169,554.4102" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="229" x="1169" y="536.668">本地修改订单状态为OS_AttachChange</text><polygon fill="#A80036" points="283,579.7207,273,583.7207,283,587.7207,279,583.7207" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="277" x2="714" y1="583.7207" y2="583.7207"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="185" x="289" y="578.9785">修改 OS_AttachChange 给用户</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="272" x2="314" y1="626.8418" y2="626.8418"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="314" x2="314" y1="626.8418" y2="639.8418"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="273" x2="314" y1="639.8418" y2="639.8418"/><polygon fill="#A80036" points="283,635.8418,273,639.8418,283,643.8418,279,639.8418" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="203" x="279" y="622.0996">查看价格是否满意 ， 满意则去支付</text><path d="M99,596.7207 L99,651.7207 L263,651.7207 L263,606.7207 L253,596.7207 L99,596.7207 " fill="#FBFB77" filter="url(#f9hx7dtlzbg12)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M253,596.7207 L253,606.7207 L263,606.7207 L253,596.7207 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143" x="105" y="614.2891">如果不满意可以拒绝支付</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="109" y="629.5996"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="105" y="644.9102">不商谈也可以直接支付</text><rect fill="#EEEEEE" filter="url(#f9hx7dtlzbg12)" height="3" style="stroke: #EEEEEE; stroke-width: 1.0;" width="1528" x="0" y="684.6631"/><line style="stroke: #000000; stroke-width: 1.0;" x1="0" x2="1528" y1="684.6631" y2="684.6631"/><line style="stroke: #000000; stroke-width: 1.0;" x1="0" x2="1528" y1="687.6631" y2="687.6631"/><rect fill="#EEEEEE" filter="url(#f9hx7dtlzbg12)" height="28.0215" style="stroke: #000000; stroke-width: 2.0;" width="130" x="699" y="671.6523"/><text fill="#000000" font-family="sans-serif" font-size="17" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="116" x="705" y="692.0879">商量价格结束=</text><rect fill="#EEEEEE" filter="url(#f9hx7dtlzbg12)" height="3" style="stroke: #EEEEEE; stroke-width: 1.0;" width="1528" x="0" y="730.3291"/><line style="stroke: #000000; stroke-width: 1.0;" x1="0" x2="1528" y1="730.3291" y2="730.3291"/><line style="stroke: #000000; stroke-width: 1.0;" x1="0" x2="1528" y1="733.3291" y2="733.3291"/><rect fill="#EEEEEE" filter="url(#f9hx7dtlzbg12)" height="23.3105" style="stroke: #000000; stroke-width: 2.0;" width="96" x="716" y="719.6738"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="78" x="722" y="736.2422">用户发起支付</text><polygon fill="#A80036" points="703,770.2949,713,774.2949,703,778.2949,707,774.2949" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="272" x2="709" y1="774.2949" y2="774.2949"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="91" x="279" y="769.5527">调用预知付接口</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="715" x2="757" y1="817.416" y2="817.416"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="757" x2="757" y1="817.416" y2="830.416"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="716" x2="757" y1="830.416" y2="830.416"/><polygon fill="#A80036" points="726,826.416,716,830.416,726,834.416,722,830.416" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="246" x="722" y="812.6738">服务端 将 商品状态改成订单为 OS_Paying</text><path d="M499,787.2949 L499,842.2949 L706,842.2949 L706,797.2949 L696,787.2949 L499,787.2949 " fill="#FBFB77" filter="url(#f9hx7dtlzbg12)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M696,787.2949 L696,797.2949 L706,797.2949 L696,787.2949 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="164" x="505" y="804.8633">此时 商户 不能进行订单修改</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="147" x="505" y="820.1738">商户发起的订单修改 将会</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="186" x="505" y="835.4844">发送失败 没有权限修改这个订单</text><polygon fill="#A80036" points="703,869.5371,713,873.5371,703,877.5371,707,873.5371" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="272" x2="709" y1="873.5371" y2="873.5371"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="392" x="279" y="868.7949">调用支付接口 支付  服务端 将 商品状态改成订 单处理中 OS_Paying</text><polygon fill="#A80036" points="283,898.8477,273,902.8477,283,906.8477,279,902.8477" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="277" x2="714" y1="902.8477" y2="902.8477"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="153" x="289" y="898.1055">推送 OrderPayDoneEvent</text><polygon fill="#A80036" points="1150,963.7793,1160,967.7793,1150,971.7793,1154,967.7793" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="715" x2="1156" y1="967.7793" y2="967.7793"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="153" x="722" y="963.0371">推送 OrderPayDoneEvent</text><path d="M338,915.8477 L338,1001.8477 L706,1001.8477 L706,925.8477 L696,915.8477 L338,915.8477 " fill="#FBFB77" filter="url(#f9hx7dtlzbg12)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M696,915.8477 L696,925.8477 L706,925.8477 L696,915.8477 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="233" x="344" y="933.416">之后发送的订单消息 , 内容不能进行修改</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="347" x="344" y="948.7266">只能变更状态 body 只有 orderid 和 status ，其他字段为空</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="348" y="964.0371"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="216" x="344" y="979.3477">客户端会通过状态 选择性更新 订单表</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="348" y="994.6582"/><polygon fill="#A80036" points="726,1028.7109,716,1032.7109,726,1036.7109,722,1032.7109" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="720" x2="1161" y1="1032.7109" y2="1032.7109"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="213" x="732" y="1027.9688">调用发送订单接口 状态为 OS_Taked</text><polygon fill="#A80036" points="283,1093.6426,273,1097.6426,283,1101.6426,279,1097.6426" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="277" x2="714" y1="1097.6426" y2="1097.6426"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="161" x="289" y="1092.9004">修改 订单状态为 OS_Taked</text><path d="M5,1045.7109 L5,1131.7109 L263,1131.7109 L263,1055.7109 L253,1045.7109 L5,1045.7109 " fill="#FBFB77" filter="url(#f9hx7dtlzbg12)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M253,1045.7109 L253,1055.7109 L263,1055.7109 L253,1045.7109 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="99" x="11" y="1063.2793">此时 商品支付 后</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="237" x="11" y="1078.5898">用户可以选择 催单 完成订单 和 申请撤单</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="117" x="11" y="1093.9004">但不能直接取消订单</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="15" y="1109.2109"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="207" x="11" y="1124.5215">支付后 取消订单的能力 由 商家决定</text><rect fill="#EEEEEE" filter="url(#f9hx7dtlzbg12)" height="3" style="stroke: #EEEEEE; stroke-width: 1.0;" width="1528" x="0" y="1161.9189"/><line style="stroke: #000000; stroke-width: 1.0;" x1="0" x2="1528" y1="1161.9189" y2="1161.9189"/><line style="stroke: #000000; stroke-width: 1.0;" x1="0" x2="1528" y1="1164.9189" y2="1164.9189"/><rect fill="#EEEEEE" filter="url(#f9hx7dtlzbg12)" height="23.3105" style="stroke: #000000; stroke-width: 2.0;" width="44" x="742" y="1151.2637"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="26" x="748" y="1167.832">拒单</text><polygon fill="#A80036" points="726,1229.8506,716,1233.8506,726,1237.8506,722,1233.8506" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="720" x2="1161" y1="1233.8506" y2="1233.8506"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="217" x="732" y="1229.1084">调用发送订单接口 状态为 OS_Refuse</text><path d="M443,1189.5742 L443,1260.5742 L706,1260.5742 L706,1199.5742 L696,1189.5742 L443,1189.5742 " fill="#FBFB77" filter="url(#f9hx7dtlzbg12)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M696,1189.5742 L696,1199.5742 L706,1199.5742 L696,1189.5742 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="449" y="1207.1426">如果商家发现用户支付的金额不满意</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="242" x="449" y="1222.4531">商家可以选择 调用拒单接口 取消这个订单</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="91" x="449" y="1237.7637">此时退款回用户</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="453" y="1253.0742"/><polygon fill="#A80036" points="283,1287.127,273,1291.127,283,1295.127,279,1291.127" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="277" x2="714" y1="1291.127" y2="1291.127"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="165" x="289" y="1286.3848">修改 订单状态为 OS_Refuse</text><rect fill="#EEEEEE" filter="url(#f9hx7dtlzbg12)" height="3" style="stroke: #EEEEEE; stroke-width: 1.0;" width="1528" x="0" y="1319.7822"/><line style="stroke: #000000; stroke-width: 1.0;" x1="0" x2="1528" y1="1319.7822" y2="1319.7822"/><line style="stroke: #000000; stroke-width: 1.0;" x1="0" x2="1528" y1="1322.7822" y2="1322.7822"/><rect fill="#EEEEEE" filter="url(#f9hx7dtlzbg12)" height="23.3105" style="stroke: #000000; stroke-width: 2.0;" width="44" x="742" y="1309.127"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="26" x="748" y="1325.6953">催单</text><polygon fill="#A80036" points="703,1359.748,713,1363.748,703,1367.748,707,1363.748" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="272" x2="709" y1="1363.748" y2="1363.748"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="152" x="279" y="1359.0059">修改 订单状态为 OS_Urge</text><polygon fill="#A80036" points="1150,1389.0586,1160,1393.0586,1150,1397.0586,1154,1393.0586" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="715" x2="1156" y1="1393.0586" y2="1393.0586"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="122" x="722" y="1388.3164">向商家推送 OS_Urge</text><rect fill="#EEEEEE" filter="url(#f9hx7dtlzbg12)" height="3" style="stroke: #EEEEEE; stroke-width: 1.0;" width="1528" x="0" y="1421.7139"/><line style="stroke: #000000; stroke-width: 1.0;" x1="0" x2="1528" y1="1421.7139" y2="1421.7139"/><line style="stroke: #000000; stroke-width: 1.0;" x1="0" x2="1528" y1="1424.7139" y2="1424.7139"/><rect fill="#EEEEEE" filter="url(#f9hx7dtlzbg12)" height="23.3105" style="stroke: #000000; stroke-width: 2.0;" width="83" x="722.5" y="1411.0586"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="65" x="728.5" y="1427.627">发货和处理</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1162" x2="1204" y1="1533.0771" y2="1533.0771"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1204" x2="1204" y1="1533.0771" y2="1546.0771"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1163" x2="1204" y1="1546.0771" y2="1546.0771"/><polygon fill="#A80036" points="1173,1542.0771,1163,1546.0771,1173,1550.0771,1169,1546.0771" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="52" x="1169" y="1528.335">拍照发货</text><path d="M763,1449.3691 L763,1612.3691 L1153,1612.3691 L1153,1459.3691 L1143,1449.3691 L763,1449.3691 " fill="#FBFB77" filter="url(#f9hx7dtlzbg12)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1143,1449.3691 L1143,1459.3691 L1153,1459.3691 L1143,1449.3691 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="229" x="769" y="1466.9375">这个接口没有提供 ，需要一个http 接口</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="773" y="1482.248"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="317" x="769" y="1497.5586">参数是 订单id 和 当前 上传的图片的 ossobjectid 地址</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="773" y="1512.8691"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="169" x="769" y="1528.1797">Post 到 http 服务器进行处理</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="773" y="1543.4902"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="369" x="769" y="1558.8008">在提供url 一个接口 通过 订单id 查看 链上数据 ， 或者这张图片</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="773" y="1574.1113"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="171" x="769" y="1589.4219">ui 展示 这个 商品的 发货图片</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="773" y="1604.7324"/><polygon fill="#A80036" points="726,1638.7852,716,1642.7852,726,1646.7852,722,1642.7852" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="720" x2="1161" y1="1642.7852" y2="1642.7852"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="732" y="1638.043">上传 发货时图片</text><polygon fill="#A80036" points="726,1668.0957,716,1672.0957,726,1676.0957,722,1672.0957" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="720" x2="1161" y1="1672.0957" y2="1672.0957"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="204" x="732" y="1667.3535">调用 OS_Processing 更新一次处理</text><rect fill="#EEEEEE" filter="url(#f9hx7dtlzbg12)" height="3" style="stroke: #EEEEEE; stroke-width: 1.0;" width="1528" x="0" y="1703.1064"/><line style="stroke: #000000; stroke-width: 1.0;" x1="0" x2="1528" y1="1703.1064" y2="1703.1064"/><line style="stroke: #000000; stroke-width: 1.0;" x1="0" x2="1528" y1="1706.1064" y2="1706.1064"/><rect fill="#EEEEEE" filter="url(#f9hx7dtlzbg12)" height="28.0215" style="stroke: #000000; stroke-width: 2.0;" width="136" x="696" y="1690.0957"/><text fill="#000000" font-family="sans-serif" font-size="17" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="122" x="702" y="1710.5313">确认收货流程 =</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1162" x2="1204" y1="1763.2383" y2="1763.2383"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1204" x2="1204" y1="1763.2383" y2="1776.2383"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1163" x2="1204" y1="1776.2383" y2="1776.2383"/><polygon fill="#A80036" points="1173,1772.2383,1163,1776.2383,1173,1780.2383,1169,1776.2383" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="352" x="1169" y="1758.4961">快递出去后 将订单号 发私聊给用户 / 调用快递系统 绑定订单</text><path d="M881,1733.1172 L881,1788.1172 L1153,1788.1172 L1153,1743.1172 L1143,1733.1172 L881,1733.1172 " fill="#FBFB77" filter="url(#f9hx7dtlzbg12)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1143,1733.1172 L1143,1743.1172 L1153,1743.1172 L1143,1733.1172 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="251" x="887" y="1750.6855">如果是有快递等运输的需要提供 物流信息等</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="224" x="887" y="1765.9961">然后通过 普通聊天 将订单号 发给 用户</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="195" x="887" y="1781.3066">然后用户通过订单号查询物流状态</text><polygon fill="#A80036" points="726,1815.3594,716,1819.3594,726,1823.3594,722,1819.3594" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="720" x2="1161" y1="1819.3594" y2="1819.3594"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="288" x="732" y="1814.6172">修改订单 状态 为 OS_Processing/ 运输中 。。。</text><polygon fill="#A80036" points="283,1857.3252,273,1861.3252,283,1865.3252,279,1861.3252" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="277" x2="714" y1="1861.3252" y2="1861.3252"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="104" x="289" y="1856.583">推送新的订单状态</text><path d="M48,1832.3594 L48,1872.3594 L263,1872.3594 L263,1842.3594 L253,1832.3594 L48,1832.3594 " fill="#FBFB77" filter="url(#f9hx7dtlzbg12)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M253,1832.3594 L253,1842.3594 L263,1842.3594 L253,1832.3594 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="194" x="54" y="1849.9277">如果 接受到 订单 则用户可以通过</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="108" x="54" y="1865.2383">确认收货完成 订单</text><polygon fill="#A80036" points="703,1911.9463,713,1915.9463,703,1919.9463,707,1915.9463" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="272" x2="709" y1="1915.9463" y2="1915.9463"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="221" x="279" y="1911.2041">确认收货流程 修改 状态  OS_Confirm</text><path d="M22,1886.9805 L22,1926.9805 L263,1926.9805 L263,1896.9805 L253,1886.9805 L22,1886.9805 " fill="#FBFB77" filter="url(#f9hx7dtlzbg12)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M253,1886.9805 L253,1896.9805 L263,1896.9805 L253,1886.9805 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="52" x="28" y="1904.5488">订单完成</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="220" x="28" y="1919.8594">可以向服务端 上传一个 收货图片 上链</text><polygon fill="#A80036" points="1150,1953.9121,1160,1957.9121,1150,1961.9121,1154,1957.9121" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="715" x2="1156" y1="1957.9121" y2="1957.9121"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="52" x="722" y="1953.1699">订单完成</text><rect fill="#EEEEEE" filter="url(#f9hx7dtlzbg12)" height="3" style="stroke: #EEEEEE; stroke-width: 1.0;" width="1528" x="0" y="1986.5674"/><line style="stroke: #000000; stroke-width: 1.0;" x1="0" x2="1528" y1="1986.5674" y2="1986.5674"/><line style="stroke: #000000; stroke-width: 1.0;" x1="0" x2="1528" y1="1989.5674" y2="1989.5674"/><rect fill="#EEEEEE" filter="url(#f9hx7dtlzbg12)" height="23.3105" style="stroke: #000000; stroke-width: 2.0;" width="48" x="740" y="1975.9121"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="26" x="746" y="1992.4805">退货</text><polygon fill="#A80036" points="703,2026.5332,713,2030.5332,703,2034.5332,707,2030.5332" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="272" x2="709" y1="2030.5332" y2="2030.5332"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="419" x="279" y="2025.791">任何时间发送 订单Id 和 状态 OS_ApplyCancel 即可 进行撤单 退货 操作</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="715" x2="757" y1="2059.8438" y2="2059.8438"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="757" x2="757" y1="2059.8438" y2="2072.8438"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="716" x2="757" y1="2072.8438" y2="2072.8438"/><polygon fill="#A80036" points="726,2068.8438,716,2072.8438,726,2076.8438,722,2072.8438" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="319" x="722" y="2055.1016">标记 订单状态为 订单内容发生更改 OS_AttachChange</text><polygon fill="#A80036" points="1150,2098.1543,1160,2102.1543,1150,2106.1543,1154,2102.1543" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="715" x2="1156" y1="2102.1543" y2="2102.1543"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="293" x="722" y="2097.4121">推送 订单最新状态 OS_AttachChange 与商户协商</text><polygon fill="#A80036" points="726,2127.4648,716,2131.4648,726,2135.4648,722,2131.4648" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="720" x2="1161" y1="2131.4648" y2="2131.4648"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="297" x="732" y="2126.7227">同意 撤单 发送 OS_Cancel 状态和 订单Id 取消订单</text><rect fill="#EEEEEE" filter="url(#f9hx7dtlzbg12)" height="3" style="stroke: #EEEEEE; stroke-width: 1.0;" width="1528" x="0" y="2160.1201"/><line style="stroke: #000000; stroke-width: 1.0;" x1="0" x2="1528" y1="2160.1201" y2="2160.1201"/><line style="stroke: #000000; stroke-width: 1.0;" x1="0" x2="1528" y1="2163.1201" y2="2163.1201"/><rect fill="#EEEEEE" filter="url(#f9hx7dtlzbg12)" height="23.3105" style="stroke: #000000; stroke-width: 2.0;" width="44" x="742" y="2149.4648"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="26" x="748" y="2166.0332">逾期</text><polygon fill="#A80036" points="703,2212.7412,713,2216.7412,703,2220.7412,707,2216.7412" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="272" x2="709" y1="2216.7412" y2="2216.7412"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="371" x="279" y="2211.999">服务端 判断 订单的有效期 ， 如果是下单流程 直接不给用户发送</text><path d="M13,2187.7754 L13,2227.7754 L263,2227.7754 L263,2197.7754 L253,2187.7754 L13,2187.7754 " fill="#FBFB77" filter="url(#f9hx7dtlzbg12)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M253,2187.7754 L253,2197.7754 L263,2197.7754 L253,2187.7754 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="134" x="19" y="2205.3438">如果 订单长时间没支付</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="229" x="19" y="2220.6543">由服务端判断直接向双方 发送 预期事件</text><!--MD5=[f86515f9ae8c57f953e80a3b83f5cd9a]
@startuml

== 下单 ==
user -> server : 发起下单 状态 OS_Prepare
server -> business : 修改 状态 为 OS_SendOK 给商户
business-> server : 接受订单的ack
server -> user: 推送 订单接受成功 事件 修改状态 OS_RecvOK 给用户

note left
此时订单未支付

如果价格不满意

可以进行普通聊天

和商家修改成 满意的价格

end note
=== 商量价格开始===
user -> server: 发送普通消息 进行和商户沟通
note left
如果商品价格是不可修改的

可以跳过这一步

end note
server-> business : 普通聊天 进行 和商户沟通 价格

business -> server : 价格商定差不多了 ， 商户发起 订单修改接口 将订单的金额 进行修改修改

business-> business : 本地修改订单状态为OS_AttachChange

server -> user : 修改 OS_AttachChange 给用户

user -> user : 查看价格是否满意 ， 满意则去支付

note left
如果不满意可以拒绝支付

不商谈也可以直接支付
end note

=== 商量价格结束===

== 用户发起支付 ==

user -> server : 调用预知付接口
server ->server : 服务端 将 商品状态改成订单为 OS_Paying
note left
此时 商户 不能进行订单修改
商户发起的订单修改 将会
发送失败 没有权限修改这个订单
end note
user -> server : 调用支付接口 支付  服务端 将 商品状态改成订 单处理中 OS_Paying
server -> user: 推送 OrderPayDoneEvent
server -> business : 推送 OrderPayDoneEvent

note left
之后发送的订单消息 , 内容不能进行修改
只能变更状态 body 只有 orderid 和 status ，其他字段为空

客户端会通过状态 选择性更新 订单表

end note
business -> server: 调用发送订单接口 状态为 OS_Taked
server -> user : 修改 订单状态为 OS_Taked

note left
此时 商品支付 后
用户可以选择 催单 完成订单 和 申请撤单
但不能直接取消订单

支付后 取消订单的能力 由 商家决定
end note

== 拒单 ==


business -> server: 调用发送订单接口 状态为 OS_Refuse
note left
如果商家发现用户支付的金额不满意
商家可以选择 调用拒单接口 取消这个订单
此时退款回用户

end note
server -> user : 修改 订单状态为 OS_Refuse

== 催单 ==
user -> server : 修改 订单状态为 OS_Urge

server -> business : 向商家推送 OS_Urge

== 发货和处理 ==

business -> business : 拍照发货
note left
这个接口没有提供 ，需要一个http 接口

参数是 订单id 和 当前 上传的图片的 ossobjectid 地址

Post 到 http 服务器进行处理

在提供url 一个接口 通过 订单id 查看 链上数据 ， 或者这张图片

ui 展示 这个 商品的 发货图片

end note
business -> server : 上传 发货时图片
business -> server : 调用 OS_Processing 更新一次处理

=== 确认收货流程 ===



business -> business : 快递出去后 将订单号 发私聊给用户 / 调用快递系统 绑定订单
note left
如果是有快递等运输的需要提供 物流信息等
然后通过 普通聊天 将订单号 发给 用户
然后用户通过订单号查询物流状态
end note

business -> server : 修改订单 状态 为 OS_Processing/ 运输中 。。。

server -> user : 推送新的订单状态

note left
如果 接受到 订单 则用户可以通过
确认收货完成 订单
end note
user -> server : 确认收货流程 修改 状态  OS_Confirm

note left
订单完成
可以向服务端 上传一个 收货图片 上链
end note
server -> business : 订单完成

==退货  ==


user -> server : 任何时间发送 订单Id 和 状态 OS_ApplyCancel 即可 进行撤单 退货 操作

server -> server : 标记 订单状态为 订单内容发生更改 OS_AttachChange

server -> business : 推送 订单最新状态 OS_AttachChange 与商户协商

business -> server : 同意 撤单 发送 OS_Cancel 状态和 订单Id 取消订单

==  逾期 ==

user -> server : 服务端 判断 订单的有效期 ， 如果是下单流程 直接不给用户发送

note left
如果 订单长时间没支付
由服务端判断直接向双方 发送 预期事件
end note


@enduml

PlantUML version 1.2020.20(Sat Nov 21 18:02:45 CST 2020)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: zh
Country: CN
--></g></svg>